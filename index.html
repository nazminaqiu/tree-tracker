<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tree Tracking System ‚Äî Client Preview</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <!-- Firestore -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --container-bg: white;
            --header-gradient-start: #2d5016;
            --header-gradient-end: #4a7c2c;
            --header-text: white;
            --text-primary: #2d5016;
            --text-secondary: #495057;
            --text-muted: #6c757d;
            --border-color: #dee2e6;
            --bg-light: #f8f9fa;
            --bg-lighter: #f1f3f5;
            --card-bg: white;
            --input-bg: white;
            --modal-overlay: rgba(0,0,0,0.6);
        }

        [data-theme="dark"] {
            --bg-gradient-start: #1a1a2e;
            --bg-gradient-end: #16213e;
            --container-bg: #1e293b;
            --header-gradient-start: #1a472a;
            --header-gradient-end: #2d5016;
            --header-text: #ffffff;
            --text-primary: #86efac;
            --text-secondary: #ffffff;
            --text-muted: #e2e8f0;
            --border-color: #475569;
            --bg-light: #0f172a;
            --bg-lighter: #334155;
            --card-bg: #0f172a;
            --input-bg: #334155;
            --modal-overlay: rgba(0,0,0,0.8);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            padding: 20px;
            transition: background 0.3s ease;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: var(--container-bg);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            transition: background 0.3s ease;
        }

        header {
            background: linear-gradient(135deg, var(--header-gradient-start) 0%, var(--header-gradient-end) 100%);
            color: var(--header-text);
            padding: 30px;
            text-align: center;
            position: relative;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .theme-toggle {
            position: absolute;
            top: 30px;
            right: 30px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        #dbStatus {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            font-weight: 600;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .nav-tabs {
            display: flex;
            background: var(--bg-light);
            border-bottom: 2px solid var(--border-color);
            transition: background 0.3s ease, border-color 0.3s ease;
        }

        .nav-tab {
            flex: 1;
            padding: 18px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.3s;
        }

        .nav-tab:hover {
            background: var(--bg-lighter);
        }

        .nav-tab.active {
            background: var(--container-bg);
            color: var(--text-primary);
            border-bottom: 3px solid var(--text-primary);
        }

        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.3s;
            background: var(--container-bg);
            transition: background 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        h2, h3 {
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #mapTab {
            padding: 0;
        }

        .map-container {
            display: flex;
            height: 700px;
            position: relative;
        }

        #map {
            flex: 1;
            height: 100%;
            min-height: 700px;
            background: #e0e0e0;
            position: relative;
        }

        .map-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 1000;
            background: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .map-loading h3 {
            color: var(--text-primary);
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .map-loading p {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 20px;
        }

        .spinner {
            border: 4px solid var(--border-color);
            border-top: 4px solid #4a7c2c;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .map-sidebar {
            width: 350px;
            background: var(--container-bg);
            border-left: 2px solid var(--border-color);
            overflow-y: auto;
            padding: 20px;
            transition: background 0.3s ease, border-color 0.3s ease;
        }

        .map-sidebar h3 {
            color: var(--text-primary);
            margin-bottom: 20px;
            font-size: 1.3em;
            transition: color 0.3s ease;
        }

        .fruit-filter-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 25px;
        }

        .fruit-filter-btn {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .fruit-filter-btn:hover {
            border-color: var(--text-primary);
            background: var(--bg-light);
        }

        .fruit-filter-btn.active {
            background: #4a7c2c;
            color: white;
            border-color: #4a7c2c;
        }

        .fruit-icon {
            font-size: 1.4em;
        }

        .tree-list-item {
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--card-bg);
        }

        .tree-list-item:hover {
            border-color: var(--text-primary);
            background: var(--bg-light);
            transform: translateX(5px);
        }

        .tree-list-item.highlighted {
            border-color: #ffc107;
            background: #fff3cd;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .tree-list-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
            transition: color 0.3s ease;
        }

        .tree-list-detail {
            font-size: 12px;
            color: var(--text-muted);
            transition: color 0.3s ease;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 14px;
            transition: color 0.3s ease;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            background: var(--input-bg);
            color: var(--text-secondary);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--text-primary);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            padding: 14px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4a7c2c 0%, #2d5016 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 124, 44, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 2.5em;
            margin-bottom: 5px;
        }

        .stat-card p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .tree-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .tree-card {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }

        .tree-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-color: var(--text-primary);
        }

        .tree-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .tree-card h3 {
            color: var(--text-primary);
            font-size: 1.4em;
            margin-bottom: 5px;
            transition: color 0.3s ease;
        }

        .tree-card .species {
            color: var(--text-muted);
            font-style: italic;
            margin-bottom: 10px;
            transition: color 0.3s ease;
        }

        .tree-card .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--bg-lighter);
            transition: border-color 0.3s ease;
        }

        .tree-card .info-row:last-child {
            border-bottom: none;
        }

        .tree-card .label {
            font-weight: 600;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }

        .tree-card .value {
            color: var(--text-muted);
            transition: color 0.3s ease;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-healthy {
            background: #d4edda;
            color: #155724;
        }

        .status-fair {
            background: #fff3cd;
            color: #856404;
        }

        .status-poor {
            background: #f8d7da;
            color: #721c24;
        }

        .tree-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .tree-actions button {
            flex: 1;
            padding: 8px;
            font-size: 14px;
        }

        .search-filter {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .search-filter input,
        .search-filter select {
            flex: 1;
            min-width: 200px;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text-secondary);
            transition: all 0.3s;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-overlay);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--container-bg);
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            transition: background 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-muted);
            transition: color 0.3s ease;
        }

        .close-modal:hover {
            color: #dc3545;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
            transition: color 0.3s ease;
        }

        .empty-state h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        /* Custom Leaflet marker styles */
        .tree-marker {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tree-marker.highlighted {
            animation: glow 1s infinite;
            border-color: #ffc107;
            box-shadow: 0 0 20px #ffc107;
        }

        @keyframes glow {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.3); }
        }

        .location-help {
            background: var(--bg-light);
            border-left: 4px solid var(--text-primary);
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .location-help h4 {
            color: var(--text-primary);
            margin-bottom: 8px;
            transition: color 0.3s ease;
        }

        .location-help p {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 5px;
            transition: color 0.3s ease;
        }

        .btn-locate {
            background: #0066cc;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }

        .btn-locate:hover {
            background: #0052a3;
        }

        @media (max-width: 1024px) {
            .map-container {
                flex-direction: column;
                height: auto;
            }

            #map {
                height: 500px;
            }

            .map-sidebar {
                width: 100%;
                border-left: none;
                border-top: 2px solid var(--border-color);
            }
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8em;
            }

            .theme-toggle {
                position: static;
                margin: 0 auto 15px;
            }

            #dbStatus {
                font-size: 11px;
                padding: 6px 12px;
            }

            header > div {
                position: static !important;
                justify-content: center;
                margin-bottom: 10px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .tree-grid {
                grid-template-columns: 1fr;
            }

            .fruit-filter-grid {
                grid-template-columns: 1fr;
            }
        }
    
        /* Demo banner */
        .demo-banner{
            margin: 12px 20px 0 20px;
            padding: 12px 14px;
            border-radius: 12px;
            background: rgba(255, 196, 0, 0.18);
            border: 1px solid rgba(255, 196, 0, 0.35);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }
        .demo-banner__text{
            font-size: 14px;
            line-height: 1.2;
        }
        .demo-banner__actions{
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .demo-banner__btn{
            padding: 8px 12px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.25);
            background: rgba(0,0,0,0.18);
            color: inherit;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
        }
        .demo-banner__btn.secondary{
            opacity: 0.85;
        }
        .demo-banner__btn:hover{
            transform: translateY(-1px);
        }

    </style>
</head>
<body>
    <!-- Client Preview Banner -->
    <div id="clientPreviewTopBar" style="position:sticky;top:0;z-index:9999;background:#111827;color:#fff;padding:10px 14px;display:flex;align-items:center;justify-content:space-between;gap:12px;box-shadow:0 2px 10px rgba(0,0,0,.15);">
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
        <span style="font-weight:700;letter-spacing:.2px;">Client Preview</span>
        <span style="opacity:.85;">Try the dashboard, add trees, and open Map View. Data saves in your browser only.</span>
      </div>
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
        <button onclick="resetPreviewData()" style="background:#374151;color:#fff;border:0;border-radius:10px;padding:8px 10px;cursor:pointer;">Reset demo data</button>
        <button onclick="dismissClientPreviewBar()" style="background:transparent;color:#fff;border:1px solid rgba(255,255,255,.35);border-radius:10px;padding:8px 10px;cursor:pointer;">Dismiss</button>
      </div>
    </div>
    
    <div class="container">
        <header>
            <button class="theme-toggle" onclick="toggleTheme()">
                <span id="themeIcon">üåô</span>
                <span id="themeText">Dark Mode</span>
            </button>
            <div style="position: absolute; top: 30px; left: 30px; display: flex; align-items: center; gap: 8px; font-size: 12px; opacity: 0.9;">
                <span id="dbStatus">üíæ Using Demo Data</span>
            </div>
            <h1>üå≥ Tree Tracking System</h1>
            <p>Monitor and manage your orchard with interactive mapping</p>
        </header>


        <div id="demoBanner" class="demo-banner" style="display:none;">
            <div class="demo-banner__text">
                <strong>Showing demo data.</strong> Add your own trees, or load your saved trees from Firestore.
            </div>
            <div class="demo-banner__actions">
                <button class="demo-banner__btn" id="loadFromFirestoreBtn" type="button">Load from Firestore</button>
                <button class="demo-banner__btn secondary" id="dismissDemoBannerBtn" type="button">Dismiss</button>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab(event, 'dashboard')">üìä Dashboard</button>
            <button class="nav-tab" onclick="switchTab(event, 'mapTab')">üó∫Ô∏è Map View</button>
            <button class="nav-tab" onclick="switchTab(event, 'addTree')">‚ûï Add Tree</button>
            <button class="nav-tab" onclick="switchTab(event, 'viewTrees')">üå≤ View Trees</button>
            <button class="nav-tab" onclick="switchTab(event, 'reports')">üìã Reports</button>
        </div>

        <!-- Map Tab -->
        <div id="mapTab" class="tab-content">
            <div class="map-container">
                <div id="map"></div>
                <div class="map-sidebar">
                    <h3>Filter by Fruit Type</h3>
                    <div class="fruit-filter-grid" id="fruitFilters">
                        <!-- Fruit filters will be populated here -->
                    </div>

                    <h3>Trees on Map</h3>
                    <div id="treeList">
                        <!-- Tree list will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <h2 style="margin-bottom: 25px; color: #2d5016;">Dashboard Overview</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalTrees">0</h3>
                    <p>Total Trees</p>
                </div>
                <div class="stat-card">
                    <h3 id="healthyTrees">0</h3>
                    <p>Healthy Trees</p>
                </div>
                <div class="stat-card">
                    <h3 id="needsAttention">0</h3>
                    <p>Needs Attention</p>
                </div>
                <div class="stat-card">
                    <h3 id="uniqueFruits">0</h3>
                    <p>Fruit Varieties</p>
                </div>
            </div>

            <h3 style="margin-bottom: 20px; color: #2d5016;">Recent Activity</h3>
            <div id="recentActivity">
                <div class="empty-state">
                    <h3>No trees tracked yet</h3>
                    <p>Start by adding your first tree in the "Add Tree" tab</p>
                </div>
            </div>
        </div>

        <!-- Add Tree Tab -->
        <div id="addTree" class="tab-content">
            <h2 style="margin-bottom: 25px; color: #2d5016;">Add New Tree</h2>
            
            <div class="location-help">
                <h4>üìç Getting GPS Coordinates</h4>
                <p>You can get your current location or enter coordinates manually.</p>
                <p><strong>Format:</strong> latitude, longitude (e.g., 3.1478, 101.6953 for Selangor)</p>
                <button class="btn-locate" onclick="getCurrentLocation()">üìç Use My Current Location</button>
            </div>

            <form id="addTreeForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="treeId">Tree ID *</label>
                        <input type="text" id="treeId" required placeholder="e.g., TREE-001">
                    </div>
                    <div class="form-group">
                        <label for="fruitType">Fruit Type *</label>
                        <input type="text" id="fruitType" required placeholder="e.g., Mango, Apple, Orange" list="fruitSuggestions">
                        <datalist id="fruitSuggestions">
                            <option value="ü•≠ Mango">
                            <option value="üçé Apple">
                            <option value="üçä Orange">
                            <option value="üçã Lemon">
                            <option value="üçå Banana">
                            <option value="ü•• Coconut">
                            <option value="üçá Grapes">
                            <option value="üçë Peach">
                            <option value="üçê Pear">
                            <option value="üçí Cherry">
                            <option value="ü•ë Avocado">
                            <option value="üçà Melon">
                        </datalist>
                    </div>
                    <div class="form-group">
                        <label for="variety">Variety/Cultivar</label>
                        <input type="text" id="variety" placeholder="e.g., Alphonso, Fuji">
                    </div>
                    <div class="form-group">
                        <label for="plantedDate">Planted Date</label>
                        <input type="date" id="plantedDate">
                    </div>
                    <div class="form-group">
                        <label for="height">Height (meters)</label>
                        <input type="number" id="height" step="0.1" placeholder="e.g., 5.5">
                    </div>
                    <div class="form-group">
                        <label for="diameter">Trunk Diameter (cm)</label>
                        <input type="number" id="diameter" step="0.1" placeholder="e.g., 30.5">
                    </div>
                    <div class="form-group">
                        <label for="location">Location Name</label>
                        <input type="text" id="location" placeholder="e.g., North Field, Row 3">
                    </div>
                    <div class="form-group">
                        <label for="coordinates">GPS Coordinates * (latitude, longitude)</label>
                        <input type="text" id="coordinates" required placeholder="e.g., 3.1478, 101.6953">
                    </div>
                    <div class="form-group">
                        <label for="healthStatus">Health Status *</label>
                        <select id="healthStatus" required>
                            <option value="">Select Status</option>
                            <option value="healthy">Healthy</option>
                            <option value="fair">Fair</option>
                            <option value="poor">Poor</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="notes">Notes</label>
                    <textarea id="notes" placeholder="Add any additional observations, maintenance notes, or special care instructions..."></textarea>
                </div>

                <button type="submit" class="btn btn-primary">
                    <span>‚ûï</span> Add Tree to System
                </button>
            </form>
        </div>

        <!-- View Trees Tab -->
        <div id="viewTrees" class="tab-content">
            <h2 style="margin-bottom: 25px; color: #2d5016;">All Trees</h2>
            
            <div class="search-filter">
                <input type="text" id="searchInput" placeholder="üîç Search by ID, fruit type, or location...">
                <select id="filterStatus">
                    <option value="">All Status</option>
                    <option value="healthy">Healthy</option>
                    <option value="fair">Fair</option>
                    <option value="poor">Poor</option>
                </select>
                <select id="sortBy">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="fruit">Fruit Type</option>
                    <option value="height">Height</option>
                </select>
            </div>

            <div id="treesContainer" class="tree-grid">
                <div class="empty-state">
                    <h3>No trees found</h3>
                    <p>Add some trees to get started</p>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports" class="tab-content">
            <h2 style="margin-bottom: 25px; color: #2d5016;">Reports & Analytics</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="avgHeight">0</h3>
                    <p>Average Height (m)</p>
                </div>
                <div class="stat-card">
                    <h3 id="avgDiameter">0</h3>
                    <p>Average Diameter (cm)</p>
                </div>
                <div class="stat-card">
                    <h3 id="healthPercentage">0%</h3>
                    <p>Health Rate</p>
                </div>
                <div class="stat-card">
                    <h3 id="oldestTree">-</h3>
                    <p>Oldest Tree</p>
                </div>
            </div>

            <div style="margin-top: 30px;">
                <h3 style="margin-bottom: 15px; color: #2d5016;">Fruit Type Distribution</h3>
                <div id="fruitReport"></div>
            </div>

            <div style="margin-top: 30px;">
                <button class="btn btn-primary" onclick="exportData()">
                    <span>üì•</span> Export Data as JSON
                </button>
            </div>
        </div>
    </div>

    <!-- Tree Detail Modal -->
    <div id="treeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Tree Details</h2>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        /*
        ========================================
        FIREBASE / FIRESTORE SETUP INSTRUCTIONS
        ========================================
        
        To connect this system to Firebase Firestore:
        
        1. Go to https://console.firebase.google.com/
        2. Create a new project (or use existing)
        3. In Project Settings > General, find "Your apps" section
        4. Click "Web" (</>) to add a web app
        5. Copy the firebaseConfig object
        6. Replace the firebaseConfig below with your actual config
        
        7. In Firebase Console, go to Firestore Database
        8. Click "Create database"
        9. Start in "Production mode" (or test mode for development)
        10. Choose a location close to your region
        
        11. Set up Firestore Security Rules:
           Go to Firestore > Rules and use this for testing:
           
           rules_version = '2';
           service cloud.firestore {
             match /databases/{database}/documents {
               match /trees/{tree} {
                 allow read, write: if true;  // ‚ö†Ô∏è Change this for production!
               }
             }
           }
        
        12. For production, implement proper authentication and rules!
        
        The system will automatically:
        - Use Firestore if configured correctly
        - Fall back to localStorage if Firestore is unavailable
        - Show connection status in the header
        */
        
        // Firebase Configuration
        // NOTE: Replace with your own Firebase config
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        let db = null;
        let useFirestore = false;

        try {
            if (typeof firebase !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                useFirestore = true;
                console.log('Firestore initialized successfully');
            }
        } catch (error) {
            console.warn('Firestore not configured, using localStorage:', error);
            useFirestore = false;
        }

        // Update database status indicator
        function updateDBStatus() {
            const statusEl = document.getElementById('dbStatus');
            if (useFirestore) {
                statusEl.innerHTML = 'üü¢ Connected to Firestore';
            } else {
                statusEl.innerHTML = 'üíæ Using Demo Data (LocalStorage)';
            }
        }

        // Call this after DOM loads
        setTimeout(updateDBStatus, 100);

        function showDemoBanner() {
            const dismissed = localStorage.getItem(DEMO_BANNER_DISMISSED_KEY) === 'true';
            const el = document.getElementById('demoBanner');
            if (!el) return;
            if (isDemoData && !dismissed) {
                el.style.display = 'flex';
            } else {
                el.style.display = 'none';
            }
        }

        function hideDemoBanner() {
            const el = document.getElementById('demoBanner');
            if (!el) return;
            el.style.display = 'none';
        }

        function wireDemoBanner() {
            const loadBtn = document.getElementById('loadFromFirestoreBtn');
            const dismissBtn = document.getElementById('dismissDemoBannerBtn');

            if (dismissBtn) {
                dismissBtn.addEventListener('click', () => {
                    localStorage.setItem(DEMO_BANNER_DISMISSED_KEY, 'true');
                    hideDemoBanner();
                });
            }

            if (loadBtn) {
                loadBtn.addEventListener('click', async () => {
                    if (!useFirestore) {
                        alert('Firestore is not enabled/available in this build. Update Firebase config and rules, then reload.');
                        return;
                    }
                    try {
                        await loadTrees();
                        if (Array.isArray(trees) && trees.length > 0) {
                            // Persist and switch out of demo mode
                            localStorage.setItem('trees', JSON.stringify(trees));
                            localStorage.setItem(DEMO_MODE_KEY, 'false');
                            isDemoData = false;

                            updateDashboard();
                            renderTrees();
                            updateReports();
                            updateFruitFilters();
                            updateTreeList();
                            updateDBStatus();
                            showDemoBanner();

                            alert(`Loaded ${trees.length} trees from Firestore.`);
                        } else {
                            alert('No trees found in Firestore (collection "trees" is empty).');
                        }
                    } catch (e) {
                        console.error(e);
                        alert('Could not load from Firestore. Check console for details (permissions/config).');
                    }
                });
            }
        }


        // Sample data for demo/proposal - Malaysian orchard locations
        const sampleTrees = [
            {
                id: "MGO-001",
                fruitType: "ü•≠ Mango",
                variety: "Harumanis",
                plantedDate: "2020-03-15",
                height: 4.2,
                diameter: 28.5,
                location: "North Field, Row 1",
                coordinates: "3.1478, 101.6953", // Selangor
                healthStatus: "healthy",
                notes: "Excellent fruit quality this season. Regular pruning maintained.",
                dateAdded: new Date("2024-01-15").toISOString()
            },
            {
                id: "MGO-002",
                fruitType: "ü•≠ Mango",
                variety: "Chok Anan",
                plantedDate: "2019-11-20",
                height: 5.1,
                diameter: 35.2,
                location: "North Field, Row 2",
                coordinates: "3.1485, 101.6960", // Selangor
                healthStatus: "healthy",
                notes: "Heavy fruiting this year. May need additional support.",
                dateAdded: new Date("2024-01-15").toISOString()
            },
            {
                id: "DUR-001",
                fruitType: "Durian",
                variety: "Musang King",
                plantedDate: "2018-06-10",
                height: 6.8,
                diameter: 45.0,
                location: "East Section, Row 1",
                coordinates: "3.1492, 101.6975", // Selangor
                healthStatus: "healthy",
                notes: "Premium variety. Excellent yield last season.",
                dateAdded: new Date("2024-01-16").toISOString()
            },
            {
                id: "DUR-002",
                fruitType: "Durian",
                variety: "D24",
                plantedDate: "2018-06-10",
                height: 6.5,
                diameter: 42.8,
                location: "East Section, Row 2",
                coordinates: "3.1498, 101.6982", // Selangor
                healthStatus: "fair",
                notes: "Some leaf yellowing observed. Fertilizer treatment scheduled.",
                dateAdded: new Date("2024-01-16").toISOString()
            },
            {
                id: "RAM-001",
                fruitType: "üçá Rambutan",
                variety: "R4",
                plantedDate: "2021-02-08",
                height: 3.5,
                diameter: 22.0,
                location: "West Section, Row 1",
                coordinates: "3.1470, 101.6945", // Selangor
                healthStatus: "healthy",
                notes: "Young tree showing excellent growth. First harvest expected next year.",
                dateAdded: new Date("2024-01-17").toISOString()
            },
            {
                id: "RAM-002",
                fruitType: "üçá Rambutan",
                variety: "R156",
                plantedDate: "2021-02-08",
                height: 3.3,
                diameter: 20.5,
                location: "West Section, Row 2",
                coordinates: "3.1465, 101.6940", // Selangor
                healthStatus: "healthy",
                notes: "Good canopy development. Regular irrigation maintained.",
                dateAdded: new Date("2024-01-17").toISOString()
            },
            {
                id: "LAN-001",
                fruitType: "Langsat",
                variety: "Duku Langsat",
                plantedDate: "2019-09-12",
                height: 4.8,
                diameter: 30.2,
                location: "South Field, Row 1",
                coordinates: "3.1460, 101.6965", // Selangor
                healthStatus: "healthy",
                notes: "Sweet fruit quality. Popular with customers.",
                dateAdded: new Date("2024-01-18").toISOString()
            },
            {
                id: "MGO-003",
                fruitType: "ü•≠ Mango",
                variety: "Harumanis",
                plantedDate: "2020-03-15",
                height: 4.0,
                diameter: 27.0,
                location: "North Field, Row 3",
                coordinates: "3.1490, 101.6968", // Selangor
                healthStatus: "healthy",
                notes: "Consistent producer. Good disease resistance.",
                dateAdded: new Date("2024-01-19").toISOString()
            },
            {
                id: "COC-001",
                fruitType: "ü•• Coconut",
                variety: "Malayan Dwarf",
                plantedDate: "2017-05-20",
                height: 8.2,
                diameter: 38.0,
                location: "Perimeter, North Boundary",
                coordinates: "3.1505, 101.6990", // Selangor
                healthStatus: "healthy",
                notes: "Boundary tree. Regular nut production.",
                dateAdded: new Date("2024-01-20").toISOString()
            },
            {
                id: "JAC-001",
                fruitType: "Jackfruit",
                variety: "J33",
                plantedDate: "2019-04-15",
                height: 5.5,
                diameter: 36.8,
                location: "Central Area",
                coordinates: "3.1480, 101.6958", // Selangor
                healthStatus: "fair",
                notes: "Minor pest activity detected. Treatment applied.",
                dateAdded: new Date("2024-01-21").toISOString()
            },
            {
                id: "MGO-004",
                fruitType: "ü•≠ Mango",
                variety: "Chok Anan",
                plantedDate: "2020-08-10",
                height: 3.8,
                diameter: 25.5,
                location: "North Field, Row 4",
                coordinates: "3.1488, 101.6955", // Selangor
                healthStatus: "healthy",
                notes: "Young productive tree. Good fruit size.",
                dateAdded: new Date("2024-01-22").toISOString()
            },
            {
                id: "DUR-003",
                fruitType: "Durian",
                variety: "Black Thorn",
                plantedDate: "2019-01-25",
                height: 6.2,
                diameter: 40.5,
                location: "East Section, Row 3",
                coordinates: "3.1502, 101.6978", // Selangor
                healthStatus: "healthy",
                notes: "Premium cultivar. High market demand.",
                dateAdded: new Date("2024-01-23").toISOString()
            },
            {
                id: "STA-001",
                fruitType: "‚≠ê Starfruit",
                variety: "B10",
                plantedDate: "2021-07-05",
                height: 2.8,
                diameter: 18.0,
                location: "South Field, Row 2",
                coordinates: "3.1455, 101.6970", // Selangor
                healthStatus: "healthy",
                notes: "Ornamental and productive. Good for fresh market.",
                dateAdded: new Date("2024-01-24").toISOString()
            },
            {
                id: "RAM-003",
                fruitType: "üçá Rambutan",
                variety: "R4",
                plantedDate: "2021-02-08",
                height: 3.6,
                diameter: 23.0,
                location: "West Section, Row 3",
                coordinates: "3.1462, 101.6938", // Selangor
                healthStatus: "poor",
                notes: "Leaf drop observed. Root inspection scheduled. May need replanting.",
                dateAdded: new Date("2024-01-25").toISOString()
            },
            {
                id: "MGO-005",
                fruitType: "ü•≠ Mango",
                variety: "Harumanis",
                plantedDate: "2020-03-20",
                height: 4.1,
                diameter: 28.0,
                location: "North Field, Row 5",
                coordinates: "3.1482, 101.6948", // Selangor
                healthStatus: "healthy",
                notes: "Part of grafting trial. Showing excellent results.",
                dateAdded: new Date("2024-01-26").toISOString()
            }
        ];

        // --- Bootstrapping: ensure the dashboard has data immediately (even if Firestore/Leaflet fail) ---
        function bootstrapDataAndUI() {
            try {
                // Prefer existing localStorage data
                const stored = JSON.parse(localStorage.getItem('trees') || '[]');
                const storedDemoFlag = localStorage.getItem(DEMO_MODE_KEY) === 'true';
                const dismissed = localStorage.getItem(DEMO_BANNER_DISMISSED_KEY) === 'true';
                if (Array.isArray(stored) && stored.length > 0) {
                    trees = stored;
                    // If previous run was demo-seeded, keep showing banner unless user dismissed it
                    isDemoData = storedDemoFlag;
                } else if (!Array.isArray(trees) || trees.length === 0) {
                    // Seed demo data on first run
                    trees = [...sampleTrees];
                    localStorage.setItem('trees', JSON.stringify(trees));
                    localStorage.setItem(DEMO_MODE_KEY, 'true');
                    isDemoData = true;
                }
                if (dismissed) {
                    // Respect dismissal even in demo mode
                    hideDemoBanner();
                }

                // Render UI immediately
                updateDashboard();
                renderTrees();
                updateReports();
                updateFruitFilters();
                updateTreeList();
            } catch (e) {
                console.error('Bootstrap failed:', e);
            }
        }


        // Initialize map and trees
        let map;
        let markers = {};
        let trees = [];
        let isDemoData = false;
        const DEMO_MODE_KEY = 'demoMode';
        const DEMO_BANNER_DISMISSED_KEY = 'demoBannerDismissed';
        let selectedFruit = null;

        // Fruit type icons mapping
        const fruitIcons = {
            'mango': 'ü•≠',
            'apple': 'üçé',
            'orange': 'üçä',
            'lemon': 'üçã',
            'banana': 'üçå',
            'coconut': 'ü••',
            'grapes': 'üçá',
            'peach': 'üçë',
            'pear': 'üçê',
            'cherry': 'üçí',
            'avocado': 'ü•ë',
            'melon': 'üçà',
            'default': 'üå≥'
        };

        // Initialize the app
                document.addEventListener('DOMContentLoaded', () => { wireDemoBanner(); bootstrapDataAndUI(); });

window.addEventListener('load', async function() {
            console.log('üöÄ App starting...');
            
            // Wait for Leaflet to be fully loaded
            let leafletChecks = 0;
            const maxChecks = 20;
            const checkLeaflet = () => {
                return new Promise((resolve) => {
                    const interval = setInterval(() => {
                        leafletChecks++;
                        if (typeof L !== 'undefined' && L.map) {
                            clearInterval(interval);
                            console.log('‚úÖ Leaflet library loaded successfully');
                            resolve(true);
                        } else if (leafletChecks >= maxChecks) {
                            clearInterval(interval);
                            console.error('‚ùå Leaflet library failed to load');
                            alert('Map library failed to load. Please check your internet connection and refresh the page.');
                            resolve(false);
                        }
                    });
                });
            };
            
            const leafletReady = await checkLeaflet();
            window.__leafletReady = leafletReady;
            if (!leafletReady) {
                console.warn('‚ö†Ô∏è Leaflet not ready at startup; continuing without map. Map View will show an error until Leaflet loads.');
            }
            
            // Load saved theme
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeButton(savedTheme);
            
            // Ensure UI shows something immediately
            bootstrapDataAndUI();

            // Load trees from Firestore or localStorage (may overwrite demo data)
            try {
                await loadTrees();
            } catch (e) {
                console.error('loadTrees failed:', e);
            }
            console.log('üìä Trees loaded, count:', trees.length);

            // If no trees exist after attempting to load, keep/seed demo data
            if (trees.length === 0) {
                console.log('üì¶ No trees found, loading sample data...');
                trees = [...sampleTrees]; // Create a copy of sample data
                
                // Validate that all sample trees have coordinates
                const treesWithCoords = trees.filter(t => t.coordinates);
                console.log(`Sample data: ${trees.length} trees, ${treesWithCoords.length} with coordinates`);
                
                if (treesWithCoords.length === 0) {
                    console.error('‚ùå ERROR: Sample data has no coordinates!');
                } else {
                    console.log('‚úÖ Sample tree example:', trees[0]);
                }
                
                await saveTrees();
                console.log('‚úÖ Sample data loaded:', trees.length, 'trees');
            } else {
                console.log('‚úÖ Loaded existing trees:', trees.length);
            }
            
            // Log first tree for debugging
            if (trees.length > 0) {
                console.log('üå≥ First tree:', trees[0]);
            }
            
            // Now initialize everything
            // Map is initialized lazily when the user opens the Map View tab
            console.log('üìä Updating dashboard...');
            updateDashboard();
            
            console.log('üå≤ Rendering trees...');
            renderTrees();
            
            console.log('üìà Updating reports...');
            updateReports();
            
            console.log('üçé Updating fruit filters...');
            updateFruitFilters();
            
            console.log('üìã Updating tree list...');
            updateTreeList();
            
            console.log('‚úÖ App initialized successfully!');
        });

        // Load trees from Firestore or localStorage
        async function loadTrees() {
            if (useFirestore) {
                try {
                    const snapshot = await db.collection('trees').get();
                    trees = snapshot.docs.map(doc => ({ ...doc.data(), firestoreId: doc.id }));
                    console.log(`Loaded ${trees.length} trees from Firestore`);
                } catch (error) {
                    console.error('Error loading from Firestore:', error);
                    // Fallback to localStorage
                    trees = JSON.parse(localStorage.getItem('trees')) || [];
                }
            } else {
                trees = JSON.parse(localStorage.getItem('trees')) || [];
            }
        }

        // Save all trees to Firestore and localStorage
        async function saveTrees() {
            // Always save to localStorage as backup
            localStorage.setItem('trees', JSON.stringify(trees));
            
            if (useFirestore) {
                try {
                    // Save to Firestore
                    const batch = db.batch();
                    
                    for (const tree of trees) {
                        const treeData = { ...tree };
                        delete treeData.firestoreId; // Remove local ID before saving
                        
                        if (tree.firestoreId) {
                            // Update existing
                            const docRef = db.collection('trees').doc(tree.firestoreId);
                            batch.update(docRef, treeData);
                        } else {
                            // Create new
                            const docRef = db.collection('trees').doc();
                            batch.set(docRef, treeData);
                            tree.firestoreId = docRef.id;
                        }
                    }
                    
                    await batch.commit();
                    console.log('Trees saved to Firestore');
                } catch (error) {
                    console.error('Error saving to Firestore:', error);
                }
            }
        }

        // Save a single tree
        async function saveTree(tree) {
            // Add to local array
            trees.push(tree);
            
            // Save to localStorage
            localStorage.setItem('trees', JSON.stringify(trees));
            
            // Save to Firestore
            if (useFirestore) {
                try {
                    const docRef = await db.collection('trees').add(tree);
                    tree.firestoreId = docRef.id;
                    console.log('Tree saved to Firestore with ID:', docRef.id);
                } catch (error) {
                    console.error('Error saving tree to Firestore:', error);
                }
            }
        }

        // Delete a tree
        async function deleteTreeFromDB(treeId) {
            const treeIndex = trees.findIndex(t => t.id === treeId);
            if (treeIndex === -1) return;
            
            const tree = trees[treeIndex];
            
            // Remove from local array
            trees.splice(treeIndex, 1);
            
            // Save to localStorage
            localStorage.setItem('trees', JSON.stringify(trees));
            
            // Delete from Firestore
            if (useFirestore && tree.firestoreId) {
                try {
                    await db.collection('trees').doc(tree.firestoreId).delete();
                    console.log('Tree deleted from Firestore');
                } catch (error) {
                    console.error('Error deleting from Firestore:', error);
                }
            }
        }

        // Theme toggle function
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeButton(newTheme);
        }

        // Update theme button text and icon
        function updateThemeButton(theme) {
            const themeIcon = document.getElementById('themeIcon');
            const themeText = document.getElementById('themeText');
            
            if (theme === 'dark') {
                themeIcon.textContent = '‚òÄÔ∏è';
                themeText.textContent = 'Light Mode';
            } else {
                themeIcon.textContent = 'üåô';
                themeText.textContent = 'Dark Mode';
            }
        }

        // Initialize Leaflet map
        function initializeMap() {
            try {
                console.log('üó∫Ô∏è Initializing map...');
                
                // Get the map container
                const mapContainer = document.getElementById('map');
                if (!mapContainer) {
                    console.error('Map container not found!');
                    return;
                }
                
                console.log('Map container found:', mapContainer);
                
                                // If Leaflet failed to load (e.g., CDN blocked), show a friendly error and stop.
                if (typeof L === 'undefined' || !L || typeof L.map !== 'function') {
                    mapContainer.innerHTML = `
                        <div class=\"map-error\">
                            <h3>üó∫Ô∏è Map unavailable</h3>
                            <p>Leaflet couldn't be loaded. This is usually caused by a blocked CDN or no internet connection.</p>
                            <p>Please check your connection and refresh, or allow access to <code>unpkg.com</code>.</p>
                        </div>
                    `;
                    return;
                }

// Show loading indicator
                mapContainer.innerHTML = `
                    <div class="map-loading">
                        <h3>üó∫Ô∏è Loading Map</h3>
                        <p>Initializing Leaflet and fetching tiles...</p>
                        <div class="spinner"></div>
                    </div>
                `;
                
                // Default center (Selangor, Malaysia)
                const defaultLat = 3.1478;
                const defaultLng = 101.6953;

                // Remove existing map if any
                if (map) {
                    console.log('Removing existing map...');
                    try {
                        map.remove();
                    } catch (e) {
                        console.log('Error removing old map (ok):', e.message);
                    }
                    map = null;
                }

                // Wait a bit for DOM to settle
                requestAnimationFrame(() => {
                    // Clear the container
                    mapContainer.innerHTML = '';

                    // Create map
                    console.log('Creating Leaflet map object...');
                    map = L.map('map', {
                        center: [defaultLat, defaultLng],
                        zoom: 14,
                        zoomControl: true,
                        scrollWheelZoom: true,
                        attributionControl: true
                    });

                    console.log('‚úÖ Map object created successfully');

                    // Add OpenStreetMap tiles
                    console.log('Adding tile layer...');
                    const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                        maxZoom: 19,
                        minZoom: 3
                    });
                    
                    tileLayer.addTo(map);
                    console.log('‚úÖ Tiles added to map');

                    // Listen for first tile load
                    let tilesLoaded = false;
                    tileLayer.on('load', function() {
                        if (!tilesLoaded) {
                            tilesLoaded = true;
                            console.log('‚úÖ Map tiles loaded successfully');
                        }
                    });

                    // Force map to recalculate size
                    // Force map to recalculate size after the browser has painted layout
                    requestAnimationFrame(() => {
                        requestAnimationFrame(() => {
                            if (map) {
                                map.invalidateSize(true);
                                console.log('‚úÖ Map size recalculated');
                            }
                        });
                    });

                    // Add tree markers
                    setTimeout(() => {
                        console.log('üå≥ Adding tree markers...');
                        addAllMarkers();
                    }, 600);
                    
                    console.log('‚úÖ Map initialization complete');
                });
                
            } catch (error) {
                console.error('‚ùå Error initializing map:', error);
                console.error('Error details:', error.message);
                console.error('Stack trace:', error.stack);
                
                // Show error to user
                const mapContainer = document.getElementById('map');
                if (mapContainer) {
                    mapContainer.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: var(--card-bg); color: var(--text-secondary); padding: 20px; text-align: center;">
                            <div>
                                <h3 style="color: #dc3545; margin-bottom: 10px;">‚ö†Ô∏è Map Loading Error</h3>
                                <p style="margin-bottom: 5px;"><strong>Error:</strong> ${error.message}</p>
                                <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 20px;">Check console (F12) for details</p>
                                <button onclick="location.reload()" style="padding: 10px 20px; background: #4a7c2c; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 600;">
                                    üîÑ Reload Page
                                </button>
                            </div>
                        </div>
                    `;
                }
            }
        }

        // Get fruit icon
        function getFruitIcon(fruitType) {
            if (!fruitType) return fruitIcons.default;
            
            // Check if fruit type already contains emoji
            if (/\p{Emoji}/u.test(fruitType)) {
                return fruitType.split(' ')[0]; // Get the emoji part
            }
            
            const fruitLower = fruitType.toLowerCase();
            for (const [key, icon] of Object.entries(fruitIcons)) {
                if (fruitLower.includes(key)) {
                    return icon;
                }
            }
            return fruitIcons.default;
        }

        // Get marker color based on health status
        function getMarkerColor(healthStatus) {
            switch(healthStatus) {
                case 'healthy': return '#28a745';
                case 'fair': return '#ffc107';
                case 'poor': return '#dc3545';
                default: return '#6c757d';
            }
        }

        // Add all markers to map
        function addAllMarkers() {
            console.log('Adding markers for', trees.length, 'trees');
            
            // Clear existing markers
            Object.values(markers).forEach(marker => map.removeLayer(marker));
            markers = {};

            let markersAdded = 0;
            trees.forEach(tree => {
                if (tree.coordinates) {
                    addMarkerForTree(tree);
                    markersAdded++;
                } else {
                    console.warn('Tree missing coordinates:', tree.id);
                }
            });
            
            console.log('Added', markersAdded, 'markers to map');
            
            // Auto-fit map to show all markers if there are any
            if (markersAdded > 0 && Object.keys(markers).length > 0) {
                const group = L.featureGroup(Object.values(markers));
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        // Add marker for a single tree
        function addMarkerForTree(tree) {
            const coords = parseCoordinates(tree.coordinates);
            if (!coords) {
                console.warn('Invalid coordinates for tree:', tree.id, tree.coordinates);
                return;
            }

            console.log('Creating marker for', tree.id, 'at', coords);

            const icon = getFruitIcon(tree.fruitType);
            const color = getMarkerColor(tree.healthStatus);

            const markerIcon = L.divIcon({
                className: 'custom-marker',
                html: `<div class="tree-marker" style="background-color: ${color};">${icon}</div>`,
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            });

            const marker = L.marker([coords.lat, coords.lng], { icon: markerIcon })
                .addTo(map)
                .bindPopup(createPopupContent(tree));

            marker.on('click', function() {
                highlightTree(tree.id);
            });

            markers[tree.id] = marker;
            console.log('Marker added for', tree.id);
        }

        // Parse coordinates string
        function parseCoordinates(coordString) {
            if (!coordString) return null;
            const parts = coordString.split(',').map(s => parseFloat(s.trim()));
            if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
                return { lat: parts[0], lng: parts[1] };
            }
            return null;
        }

        
        // Open external navigation to a tree's coordinates (Google Maps directions)
        function navigateToTreeCoordinates(coordString) {
            const p = parseCoordinates(coordString);
            if (!p) {
                showNotification('This tree has no valid GPS coordinates saved yet.', 'error');
                return;
            }
            const destination = encodeURIComponent(`${p.lat},${p.lng}`);
            const url = `https://www.google.com/maps/dir/?api=1&destination=${destination}&travelmode=driving`;
            window.open(url, '_blank', 'noopener');
        }

// Create popup content for marker
        function createPopupContent(tree) {
            return `
                <div style="min-width: 200px;">
                    <h3 style="margin: 0 0 10px 0; color: #2d5016;">${getFruitIcon(tree.fruitType)} ${tree.fruitType}</h3>
                    <p style="margin: 5px 0;"><strong>ID:</strong> ${tree.id}</p>
                    ${tree.variety ? `<p style="margin: 5px 0;"><strong>Variety:</strong> ${tree.variety}</p>` : ''}
                    <p style="margin: 5px 0;"><strong>Health:</strong> <span class="status-badge status-${tree.healthStatus}">${tree.healthStatus}</span></p>
                    ${tree.height ? `<p style="margin: 5px 0;"><strong>Height:</strong> ${tree.height}m</p>` : ''}
                    ${tree.location ? `<p style="margin: 5px 0;"><strong>Location:</strong> ${tree.location}</p>` : ''}
                    <div style="display:flex; gap:8px; margin-top:10px;"><button onclick="viewTreeDetails(${JSON.stringify(tree).replace(/"/g, '&quot;')})" style="padding: 8px 12px; background: #4a7c2c; color: white; border: none; border-radius: 4px; cursor: pointer; flex:1;">View Details</button><button onclick="navigateToTreeCoordinates('${tree.coordinates || ""}')" style="padding: 8px 12px; background: #2c5d7c; color: white; border: none; border-radius: 4px; cursor: pointer; flex:1;">üß≠ Navigate</button></div>
                </div>
            `;
        }

        // Update fruit filters
        function updateFruitFilters() {
            const fruits = {};
            trees.forEach(tree => {
                const fruitType = tree.fruitType || 'Unknown';
                fruits[fruitType] = (fruits[fruitType] || 0) + 1;
            });

            const container = document.getElementById('fruitFilters');
            
            if (Object.keys(fruits).length === 0) {
                container.innerHTML = '<p style="color: #6c757d; text-align: center; grid-column: 1/-1;">No fruits yet</p>';
                return;
            }

            container.innerHTML = Object.entries(fruits)
                .sort((a, b) => b[1] - a[1])
                .map(([fruit, count]) => `
                    <button class="fruit-filter-btn" onclick="filterByFruit('${fruit}')">
                        <span class="fruit-icon">${getFruitIcon(fruit)}</span>
                        <span>${fruit} (${count})</span>
                    </button>
                `).join('');
        }

        // Filter by fruit type
        function filterByFruit(fruitType) {
            // Toggle selection
            if (selectedFruit === fruitType) {
                selectedFruit = null;
                clearHighlights();
            } else {
                selectedFruit = fruitType;
                highlightFruitType(fruitType);
            }

            // Update button states
            document.querySelectorAll('.fruit-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            if (selectedFruit) {
                event.target.closest('.fruit-filter-btn').classList.add('active');
            }

            updateTreeList();
        }

        // Highlight all trees of a specific fruit type
        function highlightFruitType(fruitType) {
            clearHighlights();

            trees.forEach(tree => {
                if (tree.fruitType === fruitType && markers[tree.id]) {
                    const markerElement = markers[tree.id]._icon.querySelector('.tree-marker');
                    markerElement.classList.add('highlighted');
                    
                    // Animate marker
                    markers[tree.id]._icon.style.zIndex = 1000;
                }
            });
        }

        // Highlight a specific tree
        function highlightTree(treeId) {
            clearHighlights();

            if (markers[treeId]) {
                const markerElement = markers[treeId]._icon.querySelector('.tree-marker');
                markerElement.classList.add('highlighted');
                markers[treeId]._icon.style.zIndex = 1000;

                // Pan to tree
                const coords = parseCoordinates(trees.find(t => t.id === treeId).coordinates);
                if (coords) {
                    map.setView([coords.lat, coords.lng], 16, { animate: true });
                }
            }

            // Update tree list
            updateTreeList(treeId);
        }

        // Clear all highlights
        function clearHighlights() {
            document.querySelectorAll('.tree-marker').forEach(marker => {
                marker.classList.remove('highlighted');
            });

            document.querySelectorAll('.tree-list-item').forEach(item => {
                item.classList.remove('highlighted');
            });

            Object.values(markers).forEach(marker => {
                marker._icon.style.zIndex = '';
            });
        }

        // Update tree list in sidebar
        function updateTreeList(highlightId = null) {
            const container = document.getElementById('treeList');
            let filteredTrees = trees.filter(t => t.coordinates);

            if (selectedFruit) {
                filteredTrees = filteredTrees.filter(t => t.fruitType === selectedFruit);
            }

            if (filteredTrees.length === 0) {
                container.innerHTML = '<p style="color: #6c757d; text-align: center;">No trees to display</p>';
                return;
            }

            container.innerHTML = filteredTrees.map(tree => `
                <div class="tree-list-item ${highlightId === tree.id ? 'highlighted' : ''}" 
                     onclick="highlightTree('${tree.id}')">
                    <div class="tree-list-name">${getFruitIcon(tree.fruitType)} ${tree.fruitType} - ${tree.id}</div>
                    <div class="tree-list-detail">
                        ${tree.variety ? tree.variety + ' ‚Ä¢ ' : ''}
                        ${tree.location || 'No location name'}
                    </div>
                    <div class="tree-list-detail">
                        <span class="status-badge status-${tree.healthStatus}">${tree.healthStatus}</span>
                    </div>
                </div>
            `).join('');
        }

        // Get current location
        function getCurrentLocation() {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const lat = position.coords.latitude.toFixed(6);
                        const lng = position.coords.longitude.toFixed(6);
                        document.getElementById('coordinates').value = `${lat}, ${lng}`;
                        
                        // Center map on location
                        map.setView([lat, lng], 16);
                        
                        alert('Location set! üìç');
                    },
                    error => {
                        alert('Unable to get location. Please enter coordinates manually.');
                    }
                );
            } else {
                alert('Geolocation is not supported by your browser. Please enter coordinates manually.');
            }
        }

        // Tab switching
        function switchTab(evt, tabName) {
            console.log('Switching to tab:', tabName);

            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            if (evt && evt.target) evt.target.classList.add('active');

            if (tabName === 'mapTab') {
                console.log('Map tab activated');

                // Give the tab a moment to render, then fix Leaflet sizing reliably
                setTimeout(() => {
                    if (map) {
                        console.log('Invalidating map size...');
                        requestAnimationFrame(() => {
                            requestAnimationFrame(() => {
                                if (map) map.invalidateSize(true);
                            });
                        });

                        // Re-add markers if they're missing
                        if (Object.keys(markers).length === 0 && trees.length > 0) {
                            console.log('Markers missing, re-adding...');
                            addAllMarkers();
                        } else {
                            console.log('Markers already present:', Object.keys(markers).length);
                        }
                    } else {
                        console.log('Map not initialized, initializing now...');
                        initializeMap();
                    }
                    updateFruitFilters();
                    updateTreeList();
                }, 100);
            } else if (tabName === 'dashboard') {
                updateDashboard();
            } else if (tabName === 'viewTrees') {
                renderTrees();
            } else if (tabName === 'reports') {
                updateReports();
            }
        }

        // Add tree form submission
        document.getElementById('addTreeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const coords = document.getElementById('coordinates').value;
            if (!parseCoordinates(coords)) {
                alert('Invalid GPS coordinates format. Please use: latitude, longitude (e.g., 3.1478, 101.6953)');
                return;
            }

            const tree = {
                id: document.getElementById('treeId').value,
                fruitType: document.getElementById('fruitType').value,
                variety: document.getElementById('variety').value,
                plantedDate: document.getElementById('plantedDate').value,
                height: parseFloat(document.getElementById('height').value) || null,
                diameter: parseFloat(document.getElementById('diameter').value) || null,
                location: document.getElementById('location').value,
                coordinates: coords,
                healthStatus: document.getElementById('healthStatus').value,
                notes: document.getElementById('notes').value,
                dateAdded: new Date().toISOString()
            };
            
            await saveTree(tree);
            
            this.reset();
            alert('Tree added successfully! üå≥');
            
            updateDashboard();
            addAllMarkers();
            updateFruitFilters();
            updateTreeList();
        });

        // Update dashboard statistics
        function updateDashboard() {
            const total = trees.length;
            const healthy = trees.filter(t => t.healthStatus === 'healthy').length;
            const needsAttention = trees.filter(t => t.healthStatus === 'fair' || t.healthStatus === 'poor').length;
            const uniqueFruits = new Set(trees.map(t => t.fruitType)).size;
            
            document.getElementById('totalTrees').textContent = total;
            document.getElementById('healthyTrees').textContent = healthy;
            document.getElementById('needsAttention').textContent = needsAttention;
            document.getElementById('uniqueFruits').textContent = uniqueFruits;
            
            const recentDiv = document.getElementById('recentActivity');
            if (trees.length === 0) {
                recentDiv.innerHTML = `
                    <div class="empty-state">
                        <h3>No trees tracked yet</h3>
                        <p>Start by adding your first tree in the "Add Tree" tab</p>
                    </div>
                `;
            } else {
                const recent = [...trees].sort((a, b) => 
                    new Date(b.dateAdded) - new Date(a.dateAdded)
                ).slice(0, 5);
                
                recentDiv.innerHTML = '<div class="tree-grid">' + 
                    recent.map(tree => createTreeCard(tree)).join('') + 
                    '</div>';
            }
        }

        // Create tree card HTML
        function createTreeCard(tree) {
            const statusClass = `status-${tree.healthStatus}`;
            const statusText = tree.healthStatus.charAt(0).toUpperCase() + tree.healthStatus.slice(1);
            
            return `
                <div class="tree-card">
                    <div class="tree-card-header">
                        <div>
                            <h3>${getFruitIcon(tree.fruitType)} ${tree.fruitType}</h3>
                            <div class="species">${tree.variety || 'Standard variety'}</div>
                        </div>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Tree ID:</span>
                        <span class="value">${tree.id}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Location:</span>
                        <span class="value">${tree.location || 'Not specified'}</span>
                    </div>
                    ${tree.height ? `
                    <div class="info-row">
                        <span class="label">Height:</span>
                        <span class="value">${tree.height}m</span>
                    </div>
                    ` : ''}
                    ${tree.diameter ? `
                    <div class="info-row">
                        <span class="label">Diameter:</span>
                        <span class="value">${tree.diameter}cm</span>
                    </div>
                    ` : ''}
                    ${tree.plantedDate ? `
                    <div class="info-row">
                        <span class="label">Planted:</span>
                        <span class="value">${new Date(tree.plantedDate).toLocaleDateString()}</span>
                    </div>
                    ` : ''}
                    <div class="tree-actions">
                        <button class="btn btn-secondary" onclick='viewTreeDetails(${JSON.stringify(tree)})'>View Details</button>
                        <button class="btn btn-secondary" onclick="navigateToTreeCoordinates('${tree.coordinates || ''}')">üß≠ Navigate</button>
                        <button class="btn btn-danger" onclick="deleteTree('${tree.id}')">Delete</button>
                    </div>
                </div>
            `;
        }

        // Render all trees
        function renderTrees() {
            const container = document.getElementById('treesContainer');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value;
            const sortBy = document.getElementById('sortBy').value;
            
            let filtered = trees.filter(tree => {
                const matchesSearch = tree.fruitType.toLowerCase().includes(searchTerm) ||
                                    tree.id.toLowerCase().includes(searchTerm) ||
                                    (tree.location && tree.location.toLowerCase().includes(searchTerm)) ||
                                    (tree.variety && tree.variety.toLowerCase().includes(searchTerm));
                
                const matchesStatus = !statusFilter || tree.healthStatus === statusFilter;
                
                return matchesSearch && matchesStatus;
            });
            
            filtered.sort((a, b) => {
                switch(sortBy) {
                    case 'newest':
                        return new Date(b.dateAdded) - new Date(a.dateAdded);
                    case 'oldest':
                        return new Date(a.dateAdded) - new Date(b.dateAdded);
                    case 'fruit':
                        return a.fruitType.localeCompare(b.fruitType);
                    case 'height':
                        return (b.height || 0) - (a.height || 0);
                    default:
                        return 0;
                }
            });
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No trees found</h3>
                        <p>Try adjusting your search or filters</p>
                    </div>
                `;
            } else {
                container.innerHTML = filtered.map(tree => createTreeCard(tree)).join('');
            }
        }

        document.getElementById('searchInput').addEventListener('input', renderTrees);
        document.getElementById('filterStatus').addEventListener('change', renderTrees);
        document.getElementById('sortBy').addEventListener('change', renderTrees);

        // View tree details
        function viewTreeDetails(tree) {
            const modal = document.getElementById('treeModal');
            const modalBody = document.getElementById('modalBody');
            
            modalBody.innerHTML = `
                <div class="form-grid">
                    <div class="form-group">
                        <label>Tree ID</label>
                        <input type="text" value="${tree.id}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Fruit Type</label>
                        <input type="text" value="${getFruitIcon(tree.fruitType)} ${tree.fruitType}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Variety</label>
                        <input type="text" value="${tree.variety || 'N/A'}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Health Status</label>
                        <input type="text" value="${tree.healthStatus}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Height</label>
                        <input type="text" value="${tree.height ? tree.height + 'm' : 'N/A'}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Diameter</label>
                        <input type="text" value="${tree.diameter ? tree.diameter + 'cm' : 'N/A'}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" value="${tree.location || 'N/A'}" readonly>
                    </div>
                    <div class="form-group">
                        <label>GPS Coordinates</label>
                        <input type="text" value="${tree.coordinates || 'N/A'}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Planted Date</label>
                        <input type="text" value="${tree.plantedDate ? new Date(tree.plantedDate).toLocaleDateString() : 'N/A'}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Date Added</label>
                        <input type="text" value="${new Date(tree.dateAdded).toLocaleString()}" readonly>
                    </div>
                </div>
                ${tree.notes ? `
                <div class="form-group" style="margin-top: 20px;">
                    <label>Notes</label>
                    <textarea readonly>${tree.notes}</textarea>
                </div>
                ` : ''}
            `;
            
            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('treeModal').classList.remove('active');
        }

        async function deleteTree(treeId) {
            if (confirm('Are you sure you want to delete this tree? This action cannot be undone.')) {
                await deleteTreeFromDB(treeId);
                
                if (markers[treeId]) {
                    map.removeLayer(markers[treeId]);
                    delete markers[treeId];
                }
                
                renderTrees();
                updateDashboard();
                updateReports();
                updateFruitFilters();
                updateTreeList();
                alert('Tree deleted successfully');
            }
        }

        function updateReports() {
            if (trees.length === 0) {
                document.getElementById('avgHeight').textContent = '0';
                document.getElementById('avgDiameter').textContent = '0';
                document.getElementById('healthPercentage').textContent = '0%';
                document.getElementById('oldestTree').textContent = '-';
                document.getElementById('fruitReport').innerHTML = '<p>No data available</p>';
                return;
            }
            
            const validHeights = trees.filter(t => t.height).map(t => t.height);
            const avgHeight = validHeights.length > 0 
                ? (validHeights.reduce((a, b) => a + b, 0) / validHeights.length).toFixed(1)
                : 0;
            
            const validDiameters = trees.filter(t => t.diameter).map(t => t.diameter);
            const avgDiameter = validDiameters.length > 0
                ? (validDiameters.reduce((a, b) => a + b, 0) / validDiameters.length).toFixed(1)
                : 0;
            
            const healthyCount = trees.filter(t => t.healthStatus === 'healthy').length;
            const healthPercentage = ((healthyCount / trees.length) * 100).toFixed(0);
            
            const oldestTree = trees.filter(t => t.plantedDate)
                .sort((a, b) => new Date(a.plantedDate) - new Date(b.plantedDate))[0];
            
            document.getElementById('avgHeight').textContent = avgHeight;
            document.getElementById('avgDiameter').textContent = avgDiameter;
            document.getElementById('healthPercentage').textContent = healthPercentage + '%';
            document.getElementById('oldestTree').textContent = oldestTree ? oldestTree.fruitType : '-';
            
            const fruitCount = {};
            trees.forEach(tree => {
                const fruit = tree.fruitType;
                fruitCount[fruit] = (fruitCount[fruit] || 0) + 1;
            });
            
            const fruitHTML = Object.entries(fruitCount)
                .sort((a, b) => b[1] - a[1])
                .map(([fruit, count]) => `
                    <div class="info-row" style="padding: 15px; background: var(--bg-light); margin-bottom: 10px; border-radius: 8px;">
                        <span class="label">${getFruitIcon(fruit)} ${fruit}</span>
                        <span class="value">${count} tree${count > 1 ? 's' : ''}</span>
                    </div>
                `).join('');
            
            document.getElementById('fruitReport').innerHTML = fruitHTML;
        }

        function exportData() {
            const dataStr = JSON.stringify(trees, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `tree-data-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        document.getElementById('treeModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    </script>

<script>
  // --- Client preview helpers (safe for GitHub Pages) ---
  function dismissClientPreviewBar() {
    const bar = document.getElementById('clientPreviewTopBar');
    if (bar) bar.style.display = 'none';
    try { localStorage.setItem('tts_clientPreviewBarDismissed', '1'); } catch(e) {}
  }

  function maybeRestoreClientPreviewBar() {
    try {
      const dismissed = localStorage.getItem('tts_clientPreviewBarDismissed') === '1';
      const bar = document.getElementById('clientPreviewTopBar');
      if (bar && dismissed) bar.style.display = 'none';
    } catch(e) {}
  }

  function resetPreviewData() {
    if (!confirm('Reset demo data? This clears locally saved trees in this browser.')) return;
    try {
      localStorage.removeItem('trees');
      localStorage.removeItem('demoDataSeeded');
      localStorage.removeItem('tts_demoMode');
    } catch(e) {}
    location.reload();
  }

  window.addEventListener('DOMContentLoaded', maybeRestoreClientPreviewBar);
</script>

</body>
</html>
